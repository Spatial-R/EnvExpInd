###' @title  assess the pollutant exposure using the simplest method
###' @description using the nearest surveillance site as the refrence site to estimate the pollutant exposure.
###' @param  individual_data data.frame, inludes the refrence id, indi_id and exposure_date
###' @param  individual_id character, variable name in the individual_data, which represents the unique id for each individual
###' @param  refrence_id character, varibale name in the individual_data, which represents the nearest surveillance site for each individual
###' @param  exposure_date character, varibale name in the individual_data, which represents the start date to estimate the environment exposure
###' @param  estimate_interval continue numeric vector, the estimation period, for example: 0:30, for each individual we estimate the environment exposure ranging from the exposure_date to exposure_date + 30 days
###' @param  pollutant_data data.frame, contains the pollutant and site informatin. One column represents the site information and other columns represent the concentration of pollutants
###' @param  pollutant_site character, varibale name in the pollutant_data, which represents the site information
###' @param  pollutant_date character, varibale name in the pollutant_data, which represents the surveillance date for pollutant concentration
###' @param  pollutant_name vactor, varibale names in the pollutant_data, which represent the name of the target pollutants to be estimated
###' @examples
###' \dontrun{
###' library(EnvExpInd)
###' data(envind)
###' expoure_estimate_simple(
###'    individual_data = individual_data_tem,
###'    individual_id = "id",
###'    refrence_id = "refrence_id",
###'    exposure_date = "date",
###'    pollutant_data = pollutant_data_tem,
###'    pollutant_site = "site.name",
###'    pollutant_date = "date",
###'    pollutant_name = c("PM10","PM2.5"),
###'    estimate_interval = c(0:30))
###'    }
###' @return a list. every dataframe in the list was with the first column representing the individual id, the remaining columns represent the exposure estimation
###' in different days.
###' @export
###' @import dplyr
###' @author Bing Zhang, \url{https://github.com/Spatial-R/EnvExpInd}


expoure_estimate_simple <- function(individual_data,
                                    individual_id,
                                    refrence_id,
                                    exposure_date,
                                    pollutant_data,
                                    pollutant_site = "site",
                                    pollutant_date = "date",
                                    pollutant_name = c("pm10","so2"),
                                    estimate_interval){

  var_check_ind <- which(is.na(match(c(individual_id,refrence_id,exposure_date),names(individual_data))))
  var_check_polt <- which(is.na(match(c(pollutant_site,pollutant_date,pollutant_name),names(pollutant_data))))

  if(length(var_check_ind) > 0){
    miss_var_ind <- paste(c(individual_id,refrence_id,exposure_date)[var_check_ind],collapse = ",")
    stop(print(paste0("The names of variables: ",miss_var_ind," were not in the individual_data")))
  }

  if(length(var_check_polt) > 0){
    miss_var_polt <- paste(c(pollutant_site,pollutant_date,pollutant_name)[var_check_polt],collapse = ",")
    stop(print(paste0("The names of variables: ",miss_var_polt," were not in the pollutant_data")))
  }

  target_col <- match(c(individual_id,refrence_id,exposure_date),names(individual_data))
  individual_data <- individual_data[,target_col]
  names(individual_data) <- c("individual_id","refrence_id","exposure_date")

  pollutant.num <- length(pollutant_name)
  left.date <- min(individual_data[,"exposure_date"]);
  right.date <- max(individual_data[,"exposure_date"])
  date.check <- c(left.date + estimate_interval, right.date + estimate_interval)

  if (!all(date.check %in% (pollutant_data[,pollutant_date]))){
    warning("the date to esitmate is not fully in the pollutant dataset")
  }

  result.final <- list()

  for (i in c(1:pollutant.num)){
    pollutant_col <- match(c(pollutant_site,pollutant_date,pollutant_name[i]),names(pollutant_data))
    pollutant.type <- pollutant_data[,pollutant_col]
    names(pollutant.type) <- c("pollutant_site","pollutant_date","pollutant")
    tem.list <- lapply(1:nrow(individual_data),function(data.id){
      idividual.tem <- individual_data[data.id,]
      date.target   <- idividual.tem[1,"exposure_date"] + estimate_interval
      date.length   <- length(date.target)
      pollutant.tem <- pollutant.type[(pollutant.type$pollutant_date %in% date.target) &
                                        (pollutant.type$pollutant_site == idividual.tem$refrence_id),]
      if(nrow(pollutant.tem) == 0){
        exposure <- c(individual_data[data.id,"individual_id"], rep("NA",length(date.target)))
      } else{
        pollutant.tem <- dplyr::arrange(pollutant.tem,desc(pollutant_date))
        exposure <- c(individual_data[data.id,"individual_id"],
                      pollutant.tem$pollutant,rep("NA",date.length-nrow(pollutant.tem)))
      }
      exposure <- data.frame(matrix(exposure,ncol = (date.length + 1),nrow = 1))
      exposure[,1] <- as.character(exposure[,1])
      return(exposure)
    })
    tem.result <- dplyr::bind_rows(tem.list);
    names(tem.result) <- c("id",paste("day.",estimate_interval,sep = ""))
    result.final[[i]] <- tem.result
  }
  names(result.final) <- pollutant_name;
  return(result.final)
}
